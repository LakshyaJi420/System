<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Face Swap Filter v1.1</title>
  <meta name="viewport" content="width=640, initial-scale=1, user-scalable=no">
  <style>
    body, html { margin:0; padding:0; background:#181a1b; font-family:sans-serif; color:#fff; }
    #topbar {
      position: absolute; top:0; left:0; width:100%; background:rgba(30,30,30,0.96); z-index:20;
      display:flex; align-items:center; justify-content:space-between; padding:12px 20px;
      box-sizing:border-box; min-width: 640px;
    }
    #uploadBtn {
      padding:8px 18px; background:#00b894; border:none; color:#fff; font-weight:bold;
      border-radius:4px; cursor:pointer; font-size:15px; margin-right:10px;
      transition: background .2s;
    }
    #uploadBtn:hover { background:#019875; }
    #privacy {
      font-size:14px; color:#b2bec3; margin-left:15px;
    }
    #container {
      position:relative; width:640px; height:480px; margin:80px auto 0 auto; box-shadow:0 4px 18px #000a;
      border-radius:10px; overflow:hidden; background:#23272b;
    }
    video, canvas {
      position:absolute; top:0; left:0; width:640px; height:480px; display:block; border-radius:10px;
    }
    #footer {
      text-align:center; color:#636e72; font-size:13px; margin-top:36px;
    }
    @media (max-width:700px) {
      #container, video, canvas { width:100vw; height:75vw; max-width:100vw; max-height:75vw; min-width:0; }
      #topbar { min-width: unset; }
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div>
      <button id="uploadBtn">Upload Source Face</button>
      <span id="privacy">
        <b>Privacy:</b> All processing is 100% local. No image or video leaves your device.
      </span>
    </div>
    <span style="font-weight:bold; letter-spacing:1px; font-size:15px;">Live Face Swap Filter</span>
  </div>
  <div id="container">
    <video id="video" width="640" height="480" autoplay muted playsinline></video>
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>
  <div id="footer">
    &copy; 2025 Live Face Swap Filter &mdash; Powered by <a href="https://github.com/justadudewhohacks/face-api.js" target="_blank" style="color:#00b894;">face-api.js</a>
  </div>

  <!-- Face-API -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    let srcImg = null, srcPts = null;

    // 1) On load, start camera immediately (prompts permission)
    window.onload = () => {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }})
        .then(stream => video.srcObject = stream)
        .catch(err => {
          alert('Unable to access camera: ' + err.message);
        });
    };

    // 2) Load models in parallel
    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
      faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights')
    ]).then(() => {
      video.addEventListener('play', swapLoop);
    });

    // 3) User uploads source face
    document.getElementById('uploadBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = "file";
      input.accept = "image/*";
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        const dataURL = await new Promise(res => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.readAsDataURL(file);
        });
        srcImg = new Image();
        srcImg.onload = async () => {
          const det = await faceapi
            .detectSingleFace(srcImg, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks();
          if (!det) return alert('No face found in the uploaded image.');
          const lm = det.landmarks;
          srcPts = [
            averagePoint(lm.getLeftEye()),
            averagePoint(lm.getRightEye()),
            lm.getNose()[3]
          ];
        };
        srcImg.src = dataURL;
      };
      input.click();
    });

    // 4) Main loop: detect live face, compute transform, draw
    async function swapLoop() {
      const size = { width: video.width, height: video.height };
      faceapi.matchDimensions(canvas, size);

      setInterval(async () => {
        if (!srcImg || !srcPts) return;
        const det = await faceapi
          .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!det) return;
        const lm = det.landmarks;
        const dstPts = [
          averagePoint(lm.getLeftEye()),
          averagePoint(lm.getRightEye()),
          lm.getNose()[3]
        ];
        const M = getAffineTransform(srcPts, dstPts);
        ctx.save();
        ctx.setTransform(M.a, M.b, M.c, M.d, M.e, M.f);
        ctx.drawImage(srcImg, 0, 0);
        ctx.restore();
      }, 100);
    }

    // Helpers
    function averagePoint(arr) {
      const sum = arr.reduce((a, p) => ({ x: a.x + p.x, y: a.y + p.y }), { x: 0, y: 0 });
      return { x: sum.x / arr.length, y: sum.y / arr.length };
    }
    function getAffineTransform(src, dst) {
      const [x0,y0,x1,y1,x2,y2,u0,v0,u1,v1,u2,v2] =
        [src[0].x,src[0].y,src[1].x,src[1].y,src[2].x,src[2].y,
         dst[0].x,dst[0].y,dst[1].x,dst[1].y,dst[2].x,dst[2].y];
      const denom = x0*(y1-y2)+x1*(y2-y0)+x2*(y0-y1);
      const a = (u0*(y1-y2)+u1*(y2-y0)+u2*(y0-y1))/denom;
      const b = (v0*(y1-y2)+v1*(y2-y0)+v2*(y0-y1))/denom;
      const c = (u0*(x2-x1)+u1*(x0-x2)+u2*(x1-x0))/denom;
      const d = (v0*(x2-x1)+v1*(x0-x2)+v2*(x1-x0))/denom;
      const e = (u0*(x1*y2-x2*y1)+u1*(x2*y0-x0*y2)+u2*(x0*y1-x1*y0))/denom;
      const f = (v0*(x1*y2-x2*y1)+v1*(x2*y0-x0*y2)+v2*(x0*y1-x1*y0))/denom;
      return {a,b,c,d,e,f};
    }
  </script>
</body>
</html>